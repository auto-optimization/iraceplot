---
title: "Report generated by the iraceplot package"
output: 
  html_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include= FALSE}
if (!exists("interactive_plots")) interactive_plots <- base::interactive()
if (interactive_plots) {
  show_table <- function(x, row.names = TRUE, search = FALSE, lengthMenu = NULL, searchHighlight = TRUE, dom='lrtip', colorbar = NULL, style = list(), ...) {
    if (search) dom <- sub("r", "fr", dom)
    if (is.null(lengthMenu)) { pageLength <- NULL
    } else {
      pageLength <- lengthMenu[1]
      if(nrow(x) <= pageLength) dom <- gsub("[lip]", "", dom) # autoHideNavigation
    }
    columnDefs <- list(list(className = 'dt-right', targets = "_all"))
    tab <-
      DT::datatable(x, rownames = row.names,
                    class = 'compact row-border hover',
                    autoHideNavigation = TRUE,
                    options = list(
                      searchHighlight = search,
                      scrollX = TRUE,
                      pageLength=pageLength,
                      lengthMenu = lengthMenu,
                      dom = dom,
                      columnDefs = columnDefs)) %>% DT::formatStyle(names(x), fontSize='80%')
    for (col in colorbar) {
      if(!(col %in% colnames(x)))
        stop("Column ", col, " not found in table: ", paste0(colnames(x), collapse=", "))
      tab <- DT::formatStyle(tab, columns = col,
                             background = DT::styleColorBar(range(x[, col]), 'lightblue'),
                             backgroundSize = '98% 88%',
                             backgroundRepeat = 'no-repeat',
                             backgroundPosition = 'center')
    }
    for (s in style) {
      tab <- do.call(DT::formatStyle, c(table=tab, s))
    }
    tab
  }
} else {
  show_table <- function(x, row.names, ...)
    knitr::kable(x, row.names = row.names)
}

library(iraceplot)
library(tidyr, quietly = TRUE)
library(dplyr, quietly = TRUE)
niterations <- length(irace_results$allElites)
ninstances <- nrow(irace_results$experiments)
irace_log <- irace_results$experimentLog
byiterations <- NULL
for (i in 1:niterations) {
  nconfig <- length(unique(irace_log[irace_log[,"iteration"]==i,"configuration"]))
  nbest <- length(irace_results$allElites[[i]])
  ninstances <- length(unique(irace_log[irace_log[,"iteration"]==i,"instance"]))
  nexperiments <- nrow(irace_log[irace_log[,"iteration"]==i,])
  bestid <- irace_results$iterationElites[[i]]
  byiterations <- rbind(byiterations, c(i, nconfig, ninstances, nexperiments, nbest, bestid))
}
colnames(byiterations) <- c("iteration", "configurations", "instances", "experiments", "elites", "best id")

byinstance <- NULL
instances <- irace_results$scenario$instances[irace_results$state$.irace$instancesList[1:ninstances, "instance"]]
for (i in 1:length(instances)) {
  iname <- basename(instances[i])
  nexperiments <-  nrow(irace_log[irace_log[,"instance"]==i,])
  imean <- mean(irace_results$experiments[i,], na.rm=TRUE)
  ibest <- min(irace_results$experiments[i,], na.rm=TRUE)
  iworst <- max(irace_results$experiments[i,], na.rm=TRUE)
  imedian <- median(irace_results$experiments[1,], na.rm = TRUE)
  bestid <- which.min(irace_results$experiments[i,])
  byinstance <- rbind(byinstance, c(iname, nexperiments, imean, imedian, ibest, iworst, bestid))
}
colnames(byinstance) <- c("instance", "experiments", "mean", "median", "best", "worst", "best id" )
best_elites <- as.character(irace_results$allElites[[length(irace_results$allElites)]])
```

# General information

- Iterations: `r {niterations}`
- Configurations: `r {nrow(irace_results$allConfigurations)}`
- Instances: `r {ninstances}`
- Experiments: `r {nrow(irace_results$experimentLog)}`
- Elite configurations: `r {length(irace_results$allElites[[niterations]])}`

## By iteration

```{r,fig.align="center", echo=FALSE}
show_table(byiterations, lengthMenu = c(20, 50, 100),
           colorbar = c("configurations", "instances", "experiments", "elites"))
```

## By instance

```{r,fig.align="center", echo=FALSE}
show_table(byinstance, lengthMenu = c(20, 50, 100), search = TRUE)
#           colorbar = c("experiments", "mean", "median", "best", "worst"))
#columnDefs = list(list(targets = -1, searchable = FALSE))
```


# Parameter settings
## Elite configurations

The final best configurations found by irace are:

```{r,fig.align="center", echo=FALSE}
show_table(irace_results$allConfigurations[best_elites, , drop=FALSE],
           row.names = FALSE, lengthMenu = c(10,20))
```

## Parallel coordinates visualization (only elites)

```{r,fig.align="center", out.width="100%", echo=FALSE}
parallel_coord(irace_results)
```

## Parameter values sampling
The frequency of the parameter values sampled by irace:

```{r,fig.align="center", out.width="100%", echo=FALSE}
sampling_frequency(irace_results)
```



# Performance

## Testing performance

Performance of the final elite configurations on the test instances:

```{r,fig.align="center", echo=FALSE}
if (has_testing_data(irace_results)) {
best_results <- as_tibble(irace_results$testing$experiments[, best_elites])
best_results <- best_results %>% pivot_longer(all_of(best_elites), names_to="ID") %>% group_by(ID) %>% summarise(n_instances = sum(!is.na(value)), mean = mean(value), sd = sd(value), median = median(value), min = min(value), max = max(value))
best_results <- best_results[match(best_elites, best_results$ID), , drop = FALSE]
show_table(best_results, row.names = FALSE, lengthMenu = c(5, 10))
} else {
  cat("No test instances given.\n")
}
```

The final elite configuration performance on the test set:

```{r,fig.align="center", out.width="100%", echo=FALSE}
if (!has_testing_data(irace_results)) {
  cat("No test instances given.\n")
} else {
  boxplot_test(irace_results, type = "best")
}
```

Iteration elite configuration performance on the test set:

```{r,fig.align="center", out.width="100%", echo=FALSE}
if (irace_results$scenario$testIterationElites && has_testing_data(irace_results)) {
   boxplot_test(irace_results, type = "all", show_points=FALSE)
} else{
  cat("Iteration elites were not tested.\n")
}
```

## Training performance 

Performance of the final elite configurations on the training instances:

```{r,fig.align="center", echo=FALSE}
best_results <- as_tibble(irace_results$experiments[, best_elites])
best_results <- best_results %>% pivot_longer(all_of(best_elites), names_to="ID") %>% group_by(ID) %>% summarise(n_instances = sum(!is.na(value)), mean = mean(value), sd = sd(value), median = median(value), min = min(value), max = max(value))
best_results <- best_results[match(best_elites, best_results$ID), , drop = FALSE]
show_table(best_results, row.names = FALSE, lengthMenu = c(10, 20, 50, 100))
```

Final elite configurations performance on the training set:

```{r,fig.align="center", out.width="100%", echo=FALSE}
boxplot_training(irace_results)
```

# Races overview

```{r,fig.align="center", out.width="100%", echo=FALSE}
plot_experiments_matrix(irace_results, interactive = interactive_plots)
```


